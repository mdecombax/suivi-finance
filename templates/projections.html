<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suivi Finance ‚Äî Projections</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/settings_modal.css">
    <link rel="stylesheet" href="/static/css/projections.css">

    <!-- Meta -->
    <link rel="icon" href="/static/images/favicon.svg" type="image/svg+xml" />
    <link rel="icon" href="/static/images/favicon.ico" type="image/x-icon" sizes="any" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK (compat pour coh√©rence avec toutes les pages) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Modules partag√©s -->
    <script src="/static/js/shared/firebase-config.js"></script>
    <script src="/static/js/shared/auth.js"></script>
    <script src="/static/js/shared/utils.js"></script>
    <script src="/static/js/user_dropdown.js"></script>
    <script src="/static/js/settings_modal.js"></script>
</head>
<body>
    <div class="shell">
        {% set active_page = 'projections' %}
        {% include 'components/header.html' %}

        <main class="main-content">
            <div class="projections-container">
                <header class="page-header">
                    <h1 class="page-title">Projections Financi√®res</h1>
                    <p class="page-subtitle">Analysez l'√©volution future de votre portefeuille selon diff√©rents sc√©narios</p>
                </header>

                <!-- Param√®tres de projection -->
                <section class="parameters-section fade-in">
                    <h2 class="section-title">Param√®tres de Projection</h2>
                    <form class="parameters-form" id="projectionForm">
                        <div class="form-group">
                            <label for="currentValue">Valeur Actuelle (‚Ç¨)</label>
                            <input type="number" id="currentValue" name="current_value" value="10000" min="0" step="100">
                        </div>

                        <div class="form-group">
                            <label for="monthlyContribution">Contribution Mensuelle (‚Ç¨)</label>
                            <input type="number" id="monthlyContribution" name="monthly_contribution" value="0" min="0" step="50">
                        </div>

                        <div class="form-group">
                            <label for="timeHorizon">Horizon Temporel (ann√©es)</label>
                            <input type="number" id="timeHorizon" name="time_horizon_years" value="10" min="1" max="50" step="1">
                        </div>
                    </form>

                    <button type="button" class="calculate-btn" onclick="calculateProjections()">
                        <span id="calculateText">Calculer les Projections</span>
                        <span id="loadingSpinner" class="loading-spinner" style="display: none;"></span>
                    </button>
                </section>

                <!-- Messages d'erreur -->
                <div id="errorMessage" class="error-message" style="display: none;"></div>

                <!-- Sc√©narios -->
                <section id="scenariosSection" class="scenarios-grid" style="display: none;">
                    <div class="scenario-card pessimist fade-in">
                        <h3 class="scenario-title">Sc√©nario Pessimiste</h3>
                        <p class="scenario-description">Crise prolong√©e, inflation √©lev√©e (3% de rendement annuel)</p>
                        <div class="scenario-metrics" id="pessimistMetrics"></div>
                    </div>

                    <div class="scenario-card normal fade-in">
                        <h3 class="scenario-title">Sc√©nario Normal</h3>
                        <p class="scenario-description">Bas√© sur les moyennes historiques (7% de rendement annuel)</p>
                        <div class="scenario-metrics" id="normalMetrics"></div>
                    </div>

                    <div class="scenario-card optimist fade-in">
                        <h3 class="scenario-title">Sc√©nario Optimiste</h3>
                        <p class="scenario-description">Forte croissance √©conomique (11% de rendement annuel)</p>
                        <div class="scenario-metrics" id="optimistMetrics"></div>
                    </div>
                </section>

                <!-- Graphique d'√©volution -->
                <section id="chartSection" class="chart-section fade-in" style="display: none;">
                    <h2 class="chart-title">√âvolution du Portefeuille</h2>
                    <div class="chart-container">
                        <canvas id="projectionChart"></canvas>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modale des param√®tres -->
    {% include 'components/settings_modal.html' %}

    <script>
        let projectionChart = null;

        // Forcer le th√®me dark
        document.documentElement.setAttribute('data-theme', 'dark');

        // Charger la valeur actuelle du portefeuille
        async function loadPortfolioValue() {
            try {
                const result = await apiGet('/api/portfolio?account_type=pea');
                if (result.success && result.data) {
                    const currentValue = result.data.current_value || 10000;
                    document.getElementById('currentValue').value = Math.round(currentValue);
                }
            } catch (error) {
                console.warn('Impossible de r√©cup√©rer la valeur du portefeuille, utilisation de la valeur par d√©faut');
            }
        }

        // V√©rifier l'acc√®s premium
        async function checkPremiumAccess() {
            try {
                const result = await apiGet('/api/subscription');
                if (result.success) {
                    window.userPlan = result.data;
                    return result.data.is_premium === true;
                }
                return false;
            } catch (error) {
                console.error('Erreur v√©rification premium:', error);
                return false;
            }
        }

        // Afficher le message premium requis
        function showPremiumRequired() {
            const container = document.querySelector('.projections-container');
            container.innerHTML = `
                <div class="premium-required-container">
                    <div class="icon">üîí</div>
                    <h2>Fonctionnalit√© Premium</h2>
                    <p>
                        Les projections financi√®res sont r√©serv√©es aux utilisateurs Premium.
                        Acc√©dez √† des analyses avanc√©es et des projections personnalis√©es.
                    </p>
                    <button onclick="startSubscription()" class="calculate-btn" style="margin-bottom: 16px;">
                        Passer √† Premium - 3,99‚Ç¨/mois
                    </button>
                    <p style="color: var(--muted); font-size: 0.85rem;">
                        3 jours d'essai gratuit ‚Ä¢ Sans engagement
                    </p>
                    <a href="/" class="back-link">‚Üê Retour au portefeuille</a>
                </div>
            `;
        }

        // D√©marrer l'abonnement
        async function startSubscription() {
            try {
                const result = await apiPost('/api/subscription/checkout', {});
                if (result.success && result.data && result.data.url) {
                    window.location.href = result.data.url;
                } else {
                    alert('Erreur lors de la cr√©ation de la session de paiement');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Une erreur est survenue. Veuillez r√©essayer.');
            }
        }

        // Calcul des projections
        async function calculateProjections() {
            const button = document.querySelector('.calculate-btn');
            const buttonText = document.getElementById('calculateText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessage = document.getElementById('errorMessage');

            button.disabled = true;
            buttonText.style.display = 'none';
            loadingSpinner.style.display = 'inline-block';
            errorMessage.style.display = 'none';

            try {
                const formData = new FormData(document.getElementById('projectionForm'));
                const params = {
                    current_value: parseFloat(formData.get('current_value')),
                    monthly_contribution: parseFloat(formData.get('monthly_contribution')),
                    time_horizon_years: parseInt(formData.get('time_horizon_years')),
                    annual_fees_rate: 0.0075
                };

                const result = await apiPost('/api/projections', params);

                if (!result.success) {
                    throw new Error(result.error || 'Erreur lors du calcul des projections');
                }

                displayProjections(result.data);

            } catch (error) {
                console.error('Erreur:', error);
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';
            } finally {
                button.disabled = false;
                buttonText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
            }
        }

        // Afficher les r√©sultats
        function displayProjections(data) {
            const projections = data.projections;

            displayScenarioMetrics('pessimistMetrics', projections.pessimist);
            displayScenarioMetrics('normalMetrics', projections.normal);
            displayScenarioMetrics('optimistMetrics', projections.optimist);

            document.getElementById('scenariosSection').style.display = 'grid';
            document.getElementById('chartSection').style.display = 'block';

            createProjectionChart(projections);
        }

        // Afficher les m√©triques d'un sc√©nario
        function displayScenarioMetrics(containerId, projection) {
            const container = document.getElementById(containerId);

            const metrics = [
                {
                    label: 'Valeur Finale',
                    value: formatCurrency(projection.final_value),
                    class: 'positive'
                },
                {
                    label: 'Contributions Totales',
                    value: formatCurrency(projection.total_contributions),
                    class: ''
                },
                {
                    label: 'Plus-values',
                    value: formatCurrency(projection.total_gains),
                    class: projection.total_gains >= 0 ? 'positive' : 'negative'
                },
                {
                    label: 'Rendement Annualis√©',
                    value: formatPercentage(projection.annualized_return),
                    class: projection.annualized_return >= 0 ? 'positive' : 'negative'
                }
            ];

            container.innerHTML = metrics.map(metric => `
                <div class="metric-row">
                    <span class="metric-label">${metric.label}</span>
                    <span class="metric-value ${metric.class}">${metric.value}</span>
                </div>
            `).join('');
        }

        // Cr√©er le graphique
        function createProjectionChart(projections) {
            const ctx = document.getElementById('projectionChart').getContext('2d');

            if (projectionChart) {
                projectionChart.destroy();
            }

            const labels = projections.normal.labels.filter(label => label !== '');
            const pessimistData = projections.pessimist.monthly_values.filter((_, index) =>
                projections.pessimist.labels[index] !== ''
            );
            const normalData = projections.normal.monthly_values.filter((_, index) =>
                projections.normal.labels[index] !== ''
            );
            const optimistData = projections.optimist.monthly_values.filter((_, index) =>
                projections.optimist.labels[index] !== ''
            );

            projectionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sc√©nario Pessimiste',
                            data: pessimistData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Sc√©nario Normal',
                            data: normalData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Sc√©nario Optimiste',
                            data: optimistData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#e5e7eb',
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'P√©riode', color: '#9ca3af' },
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'Valeur du Portefeuille (‚Ç¨)', color: '#9ca3af' },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) { return formatCurrency(value); }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Recalculer avec debounce
        const debouncedCalculate = debounce(() => calculateProjections(), 1000);
        document.getElementById('projectionForm').addEventListener('input', debouncedCalculate);

        // Initialisation
        function init() {
            // Initialiser Firebase
            initializeFirebase();

            // Initialiser l'authentification
            initAuth({
                requireAuth: true,
                onAuthenticated: async (user, token) => {
                    // V√©rifier le statut premium
                    const hasPremium = await checkPremiumAccess();
                    if (!hasPremium) {
                        showPremiumRequired();
                        return;
                    }

                    // Charger la valeur du portefeuille
                    await loadPortfolioValue();

                    // Calculer les projections initiales
                    setTimeout(() => calculateProjections(), 500);
                }
            });
        }

        // D√©marrer
        init();

        // Exposer les fonctions globalement
        window.startSubscription = startSubscription;
        window.calculateProjections = calculateProjections;
    </script>
</body>
</html>
