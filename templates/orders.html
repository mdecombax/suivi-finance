<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suivi Finance ‚Äî Ordres</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/settings_modal.css">
    <style>
        /* Styles sp√©cifiques √† la page des ordres */
        .add-order-section {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .orders-section {
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }
        
        .info-tip {
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(130,196,255,0.1);
            border: 1px solid rgba(130,196,255,0.2);
            border-radius: var(--border-radius-lg);
            font-size: 0.9rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeInDown 0.4s ease-out 0.3s both;
        }
        
        .info-tip::before {
            content: 'üí°';
            font-size: 1.2rem;
        }
        
        .form-input:focus {
            transform: scale(1.02);
        }
        
        .btn-primary {
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: all var(--transition-normal);
            transform: translate(-50%, -50%);
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s ease-in-out infinite;
        }
        
        .table tbody tr:hover {
            transform: scale(1.01);
        }
        
        /* Animation pour les actions de suppression */
        .btn-danger {
            position: relative;
            overflow: hidden;
            transition: all var(--transition-fast);
        }
        
        .btn-danger::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: all var(--transition-normal);
            transform: translate(-50%, -50%);
        }
        
        .btn-danger:hover::before {
            width: 200px;
            height: 200px;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px) scale(1.05);
        }
        
        /* Animation de confirmation pour les suppressions */
        .delete-confirm {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Effet de succ√®s pour les actions */
        .success-flash {
            animation: successFlash 0.6s ease-out;
        }
        
        @keyframes successFlash {
            0% { background-color: transparent; }
            50% { background-color: rgba(76,175,80,0.2); }
            100% { background-color: transparent; }
        }
        
        /* Responsive am√©lior√© */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <meta name="robots" content="noindex" />
    <meta name="color-scheme" content="light dark" />
    <link rel="icon" href="/static/images/favicon.svg" type="image/svg+xml" />
    <link rel="icon" href="/static/images/favicon.ico" type="image/x-icon" sizes="any" />
    <meta name="description" content="Gestion des ordres d'investissement" />

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        // Configuration Firebase
        const firebaseConfig = {
            "apiKey": "AIzaSyBFrk8tZVEuM0LeQ0D8kJ7N2Bt-KyuQv0I",
            "authDomain": "suivi-financ.firebaseapp.com",
            "projectId": "suivi-financ",
            "storageBucket": "suivi-financ.firebasestorage.app",
            "messagingSenderId": "959011615445",
            "appId": "1:959011615445:web:993be6cee77fc6cedae85c",
            "measurementId": "G-8QXCJ8J23S"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Exposer Firebase globalement
        window.firebaseAuth = auth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
    </script>

    <!-- Script centralis√© pour le dropdown utilisateur -->
    <script src="/static/js/user_dropdown.js"></script>

    <!-- Script centralis√© pour la modale des param√®tres -->
    <script src="/static/js/settings_modal.js"></script>
</head>
<body>
    <div class="shell">
        {% set active_page = 'orders' %}
        {% include 'components/header.html' %}

        <main>
            <div id="loadingState" class="loading">
                <div class="loading-spinner animate-spin"></div>
                <span class="loading-text">Chargement de vos ordres...</span>
            </div>
                    
            <div id="ordersContent" style="display: none;">
                <!-- Add Order Section -->
                <div class="add-order-section card">
                    <div class="section-title">Ajouter un ordre</div>
                    <div id="messageContainer"></div>
                    <form id="addOrderForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="isin">ISIN</label>
                                <input 
                                    class="form-input" 
                                    type="text" 
                                    id="isin" 
                                    name="isin" 
                                    placeholder="LU1681043599" 
                                    required 
                                    maxlength="12"
                                />
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="quantity">Quantit√©</label>
                                <input 
                                    class="form-input" 
                                    type="number" 
                                    id="quantity" 
                                    name="quantity" 
                                    placeholder="10" 
                                    step="0.01" 
                                    min="0.01" 
                                    required 
                                />
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="date">Date</label>
                                <input 
                                    class="form-input" 
                                    type="date" 
                                    id="date" 
                                    name="date" 
                                    required 
                                />
                            </div>
                        </div>
                        <div class="info-tip">
                            Le prix sera r√©cup√©r√© automatiquement via JustETF ou Yahoo Finance pour la date s√©lectionn√©e
                        </div>
                        <button type="submit" class="btn btn-primary" id="addOrderBtn">
                            <span id="addOrderBtnText">Ajouter l'ordre</span>
                            <span id="addOrderBtnLoading" class="loading-spinner" style="display: none;"></span>
                        </button>
                    </form>
                </div>

                <!-- Orders History Section -->
                <div class="orders-section table-container">
                    <div class="table-header">
                        <div class="table-title">Historique des ordres</div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>ISIN</th>
                                <th>Quantit√©</th>
                                <th>Prix Unitaire</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modale des param√®tres -->
    {% include 'components/settings_modal.html' %}

    <script>
        // √âtat de l'application
        let orders = [];
        let currentUser = null;
        let authToken = null;

        // Forcer le th√®me dark
        document.documentElement.setAttribute('data-theme', 'dark');

        // Gestion des messages
        function showMessage(message, type = 'error') {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="${type} animate-fadeInDown">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 3000);
            }
        }

        // Chargement des ordres
        async function loadOrders() {
            try {
                if (!authToken) {
                    throw new Error('Utilisateur non authentifi√©');
                }

                const response = await fetch('/api/orders', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erreur lors du chargement des ordres');
                }

                const result = await response.json();
                if (result.success) {
                    orders = result.orders;
                    updateOrdersTable();
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des ordres:', error);
                showMessage('Erreur lors du chargement des ordres', 'error');
            }
        }

        function updateOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');
            
            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-state">
                        <td colspan="6" style="text-align: center; color: var(--muted); padding: 40px;">
                            <div class="empty-icon">üìã</div>
                            <div class="empty-title">Aucun ordre</div>
                            <div class="empty-description">Vous n'avez pas encore ajout√© d'ordres d'investissement</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = orders.map((order, index) => {
                const date = new Date(order.date).toLocaleDateString('fr-FR');
                const totalPrice = order.quantity * order.unitPriceEUR;

                return `
                    <tr>
                        <td class="number">${date}</td>
                        <td>${order.isin}</td>
                        <td class="number">${order.quantity.toLocaleString('fr-FR')}</td>
                        <td class="number">‚Ç¨${order.unitPriceEUR.toLocaleString('fr-FR', { minimumFractionDigits: 2 })}</td>
                        <td class="number">‚Ç¨${totalPrice.toLocaleString('fr-FR', { minimumFractionDigits: 2 })}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteOrder('${order.id}')" style="padding: 6px 12px; font-size: 0.8rem;">
                                Supprimer
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Ajout d'un ordre
        async function addOrder(orderData) {
            try {
                if (!authToken) {
                    throw new Error('Utilisateur non authentifi√©');
                }

                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de l\'ajout de l\'ordre');
                }

                const result = await response.json();
                if (result.success) {
                    showMessage('Ordre ajout√© avec succ√®s', 'success');
                    await loadOrders(); // Recharger la liste
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('Erreur lors de l\'ajout de l\'ordre:', error);
                showMessage(error.message, 'error');
            }
        }

        // Suppression d'un ordre
        async function deleteOrder(orderId) {
            // Animation de confirmation
            const deleteBtn = event.target;
            deleteBtn.classList.add('delete-confirm');
            
            setTimeout(() => {
                deleteBtn.classList.remove('delete-confirm');
            }, 500);
            
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet ordre ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/orders?order_id=${orderId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la suppression de l\'ordre');
                }

                const result = await response.json();
                if (result.success) {
                    showMessage('Ordre supprim√© avec succ√®s', 'success');
                    
                    // Animation de succ√®s sur la ligne supprim√©e
                    const row = deleteBtn.closest('tr');
                    row.classList.add('success-flash');
                    
                    setTimeout(async () => {
                        await loadOrders(); // Recharger la liste
                    }, 600);
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('Erreur lors de la suppression de l\'ordre:', error);
                showMessage(error.message, 'error');
            }
        }

        // Validation de l'ISIN
        function validateISIN(isin) {
            const isinRegex = /^[A-Z]{2}[A-Z0-9]{9}[0-9]$/;
            return isinRegex.test(isin.toUpperCase());
        }

        // Gestion du formulaire d'ajout d'ordre
        document.getElementById('addOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const isin = formData.get('isin').toUpperCase();
            const quantity = parseFloat(formData.get('quantity'));
            const date = formData.get('date');
            
            // Validation
            if (!validateISIN(isin)) {
                showMessage('ISIN invalide (format: 2 lettres + 9 caract√®res alphanum√©riques + 1 chiffre)', 'error');
                return;
            }
            
            if (quantity <= 0) {
                showMessage('La quantit√© doit √™tre positive', 'error');
                return;
            }
            
            if (!date) {
                showMessage('La date est requise', 'error');
                return;
            }
            
            const addBtn = document.getElementById('addOrderBtn');
            const addBtnText = document.getElementById('addOrderBtnText');
            const addBtnLoading = document.getElementById('addOrderBtnLoading');
            
            // Afficher le loading
            addBtn.disabled = true;
            addBtnText.style.display = 'none';
            addBtnLoading.style.display = 'inline-block';
            
            try {
                const orderData = {
                    isin: isin,
                    quantity: quantity,
                    date: date
                };
                
                await addOrder(orderData);
                
                // R√©initialiser le formulaire
                e.target.reset();
                // Remettre la date d'aujourd'hui
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
            } catch (error) {
                console.error('Erreur lors de l\'ajout de l\'ordre:', error);
            } finally {
                // Masquer le loading
                addBtn.disabled = false;
                addBtnText.style.display = 'inline';
                addBtnLoading.style.display = 'none';
            }
        });

        // Gestion de l'authentification
        function initAuth() {
            window.onAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    // Utilisateur connect√©
                    currentUser = user;
                    authToken = await user.getIdToken();

                    // Utiliser la fonction centralis√©e du module user_dropdown
                    if (typeof window.updateUserInterface === 'function') {
                        window.updateUserInterface(user);
                    }

                    // Masquer le loading et afficher le contenu
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('ordersContent').style.display = 'block';

                    // Charger les ordres
                    loadOrders();
                } else {
                    // Utilisateur non connect√©, rediriger vers la page principale
                    window.location.href = '/';
                }
            });
        }

        // Initialisation
        function init() {
            // D√©finir la date d'aujourd'hui par d√©faut
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;

            // Attendre que Firebase soit charg√© puis v√©rifier l'authentification
            setTimeout(() => {
                initAuth();
            }, 100);
        }

        // D√©marrer l'application
        init();

        // Exposer les fonctions globalement pour les boutons
        window.deleteOrder = deleteOrder;
    </script>
</body>
</html>