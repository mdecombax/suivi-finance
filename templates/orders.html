<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suivi Finance ‚Äî Ordres</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/settings_modal.css">
    <link rel="stylesheet" href="/static/css/orders.css">

    <!-- Meta -->
    <meta name="robots" content="noindex" />
    <meta name="color-scheme" content="light dark" />
    <link rel="icon" href="/static/images/favicon.svg" type="image/svg+xml" />
    <link rel="icon" href="/static/images/favicon.ico" type="image/x-icon" sizes="any" />
    <meta name="description" content="Gestion des ordres d'investissement" />

    <!-- Firebase SDK (compat pour coh√©rence avec toutes les pages) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Modules partag√©s -->
    <script src="/static/js/shared/firebase-config.js"></script>
    <script src="/static/js/shared/auth.js"></script>
    <script src="/static/js/shared/utils.js"></script>
    <script src="/static/js/user_dropdown.js"></script>
    <script src="/static/js/settings_modal.js"></script>
</head>
<body>
    <div class="shell">
        {% set active_page = 'orders' %}
        {% include 'components/header.html' %}

        <main>
            <div id="loadingState" class="loading">
                <div class="loading-spinner animate-spin"></div>
                <span class="loading-text">Chargement de vos ordres...</span>
            </div>

            <div id="ordersContent" style="display: none;">
                <!-- Add Order Section -->
                <div class="add-order-section card">
                    <div class="section-title">Ajouter un ordre</div>
                    <div id="messageContainer"></div>
                    <form id="addOrderForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="isin">ISIN</label>
                                <input
                                    class="form-input"
                                    type="text"
                                    id="isin"
                                    name="isin"
                                    placeholder="LU1681043599"
                                    required
                                    maxlength="12"
                                />
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="quantity">Quantit√©</label>
                                <input
                                    class="form-input"
                                    type="number"
                                    id="quantity"
                                    name="quantity"
                                    placeholder="10"
                                    step="0.01"
                                    min="0.01"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="date">Date</label>
                                <input
                                    class="form-input"
                                    type="date"
                                    id="date"
                                    name="date"
                                    required
                                />
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="addOrderBtn">
                            <span id="addOrderBtnText">Ajouter l'ordre</span>
                            <span id="addOrderBtnLoading" class="loading-spinner" style="display: none;"></span>
                        </button>
                    </form>
                </div>

                <!-- Orders History Section -->
                <div class="orders-section table-container">
                    <div class="table-header">
                        <div class="table-title">Historique des ordres</div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>ISIN</th>
                                <th>Quantit√©</th>
                                <th>Prix Unitaire</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modale des param√®tres -->
    {% include 'components/settings_modal.html' %}

    <script>
        // √âtat de l'application (simplifi√© - utilise AuthState global)
        let orders = [];

        // Forcer le th√®me dark
        document.documentElement.setAttribute('data-theme', 'dark');

        // Chargement des ordres (utilise apiGet du module partag√©)
        async function loadOrders() {
            try {
                const result = await apiGet('/api/orders');
                if (result.success) {
                    orders = result.orders;
                    updateOrdersTable();
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des ordres:', error);
                showMessage('Erreur lors du chargement des ordres', 'error');
            }
        }

        function updateOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');

            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-state">
                        <td colspan="6" style="text-align: center; color: var(--muted); padding: 40px;">
                            <div class="empty-icon">üìã</div>
                            <div class="empty-title">Aucun ordre</div>
                            <div class="empty-description">Vous n'avez pas encore ajout√© d'ordres d'investissement</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = orders.map((order) => {
                const date = formatDate(order.date);
                const totalPrice = order.quantity * order.unitPriceEUR;

                return `
                    <tr>
                        <td class="number">${date}</td>
                        <td>${order.isin}</td>
                        <td class="number">${formatNumber(order.quantity, 2)}</td>
                        <td class="number">${formatCurrency(order.unitPriceEUR, {maximumFractionDigits: 2})}</td>
                        <td class="number">${formatCurrency(totalPrice, {maximumFractionDigits: 2})}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteOrder('${order.id}')" style="padding: 6px 12px; font-size: 0.8rem;">
                                Supprimer
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Ajout d'un ordre (utilise apiPost du module partag√©)
        async function addOrder(orderData) {
            try {
                const result = await apiPost('/api/orders', orderData);
                if (result.success) {
                    showMessage('Ordre ajout√© avec succ√®s', 'success');
                    await loadOrders();
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('Erreur lors de l\'ajout de l\'ordre:', error);
                showMessage(error.message, 'error');
            }
        }

        // Suppression d'un ordre
        async function deleteOrder(orderId) {
            const deleteBtn = event.target;
            deleteBtn.classList.add('delete-confirm');

            setTimeout(() => {
                deleteBtn.classList.remove('delete-confirm');
            }, 500);

            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet ordre ?')) {
                return;
            }

            try {
                const result = await apiDelete(`/api/orders?order_id=${orderId}`);
                if (result.success) {
                    showMessage('Ordre supprim√© avec succ√®s', 'success');

                    const row = deleteBtn.closest('tr');
                    row.classList.add('success-flash');

                    setTimeout(async () => {
                        await loadOrders();
                    }, 600);
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('Erreur lors de la suppression de l\'ordre:', error);
                showMessage(error.message, 'error');
            }
        }

        // Gestion du formulaire d'ajout d'ordre
        document.getElementById('addOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const isin = formData.get('isin').toUpperCase();
            const quantity = parseFloat(formData.get('quantity'));
            const date = formData.get('date');

            // Validation (utilise validateISIN du module partag√©)
            if (!validateISIN(isin)) {
                showMessage('ISIN invalide (format: 2 lettres + 9 caract√®res alphanum√©riques + 1 chiffre)', 'error');
                return;
            }

            if (quantity <= 0) {
                showMessage('La quantit√© doit √™tre positive', 'error');
                return;
            }

            if (!date) {
                showMessage('La date est requise', 'error');
                return;
            }

            const addBtn = document.getElementById('addOrderBtn');
            const addBtnText = document.getElementById('addOrderBtnText');
            const addBtnLoading = document.getElementById('addOrderBtnLoading');

            addBtn.disabled = true;
            addBtnText.style.display = 'none';
            addBtnLoading.style.display = 'inline-block';

            try {
                await addOrder({ isin, quantity, date });
                e.target.reset();
                document.getElementById('date').value = getTodayISO();
            } catch (error) {
                console.error('Erreur lors de l\'ajout de l\'ordre:', error);
            } finally {
                addBtn.disabled = false;
                addBtnText.style.display = 'inline';
                addBtnLoading.style.display = 'none';
            }
        });

        // ========== PREMIUM FUNCTIONS ==========

        // Fonction pour ouvrir la modal premium
        function openPremiumModal() {
            const modal = document.getElementById('premiumModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        window.openPremiumModal = openPremiumModal;

        // Fonction pour fermer la modal premium
        function closePremiumModal() {
            const modal = document.getElementById('premiumModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
        window.closePremiumModal = closePremiumModal;

        // Fonction pour d√©marrer l'abonnement
        async function startSubscription() {
            try {
                const response = await fetch('/api/subscription/checkout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success && result.data && result.data.url) {
                    window.location.href = result.data.url;
                } else {
                    alert('Erreur lors de la cr√©ation de la session de paiement');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Une erreur est survenue. Veuillez r√©essayer.');
            }
        }

        // Fonction pour v√©rifier si l'utilisateur a acc√®s premium
        function hasPremiumAccess() {
            if (!window.userPlan) {
                return false;
            }

            const plan = window.userPlan.plan;
            const status = window.userPlan.status;
            const isPremiumFlag = window.userPlan.is_premium;

            let hasAccess = false;

            if (isPremiumFlag === true) {
                hasAccess = true;
            } else if (plan === 'premium' || plan === 'trial') {
                hasAccess = true;
            } else if ((status === 'trialing' || status === 'active') && plan !== 'freemium') {
                hasAccess = true;
            }

            return hasAccess;
        }
        window.hasPremiumAccess = hasPremiumAccess;

        // Charger le statut d'abonnement
        async function loadSubscriptionStatus() {
            try {
                const result = await apiGet('/api/subscription');
                if (result && result.data) {
                    window.userPlan = result.data;
                }
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration du statut d\'abonnement:', error);
            }
        }

        // Initialisation
        function init() {
            // Initialiser Firebase
            initializeFirebase();

            // D√©finir la date d'aujourd'hui par d√©faut
            document.getElementById('date').value = getTodayISO();

            // Initialiser l'authentification avec le module partag√©
            initAuth({
                requireAuth: true,
                onAuthenticated: async (user, token) => {
                    // Charger le statut d'abonnement
                    await loadSubscriptionStatus();

                    // Masquer le loading et afficher le contenu
                    hideElement('loadingState');
                    showElement('ordersContent');
                    document.getElementById('ordersContent').style.display = 'block';

                    // Charger les ordres
                    loadOrders();
                }
            });
        }

        // D√©marrer l'application
        init();

        // Exposer les fonctions globalement pour les boutons
        window.deleteOrder = deleteOrder;
    </script>

    <!-- Modal Premium -->
    <div id="premiumModal" class="premium-modal">
        <div class="premium-modal-content">
            <button class="premium-modal-close" onclick="closePremiumModal()">√ó</button>

            <div class="premium-modal-header">
                <div class="premium-modal-icon">‚≠ê</div>
                <h2 class="premium-modal-title">Passez √† Premium</h2>
                <p class="premium-modal-subtitle">Acc√©dez √† toutes les p√©riodes temporelles et bien plus</p>
            </div>

            <div class="premium-modal-price">
                <div class="premium-modal-price-amount">3,99‚Ç¨</div>
                <div class="premium-modal-price-period">par mois</div>
                <div class="premium-modal-trial">3 jours d'essai gratuit</div>
            </div>

            <ul class="premium-modal-features">
                <li>Acc√®s √† toutes les p√©riodes temporelles (6m, 1an, MAX)</li>
                <li>Graphiques et analyses avanc√©es</li>
                <li>Exports illimit√©s</li>
                <li>Support prioritaire</li>
            </ul>

            <button class="premium-modal-cta" onclick="startSubscription()">
                D√©marrer l'essai gratuit
            </button>

            <p class="premium-modal-note">
                Aucun paiement pendant 3 jours ‚Ä¢ Annulation √† tout moment
            </p>
        </div>
    </div>
</body>
</html>
